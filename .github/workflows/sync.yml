name: Sync Fork

on:
  schedule:
    # 每天 UTC 时间 0 点同步（可调整）
    - cron: '0 6 * * *'
  # 支持手动触发
  workflow_dispatch:
  # 当上游仓库有新 release 时触发（可选）
  repository_dispatch:
    types: [upstream-sync]

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout fork
      uses: actions/checkout@v4
      with:
        # 使用你的默认分支
        ref: main
        # 推荐添加 token 以获得推送权限
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Add upstream remote
      run: |
        git remote add upstream https://github.com/CreditTone/hooker.git
        git remote -v

    - name: Fetch upstream branches
      run: git fetch upstream

    - name: Merge upstream/main
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git checkout main
        # 尝试合并，忽略合并失败（如有冲突需要手动处理）
        git merge --no-edit upstream/main || echo "Merge conflict detected, skipping..."

    - name: Push changes
      run: |
        # 只推送成功合并的情况
        if git diff --quiet HEAD upstream/main; then
          echo "No changes to push"
        else
          git push origin main
        fi
